name: CI
on:
  pull_request:
  push:
    branches:
      - main

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      languages: ${{ steps.set-matrix.outputs.languages }}
    steps:
      - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0
      - id: set-matrix
        run: |
          languages=$(jq -r '[.devDependencies | keys[] | select(startswith("tree-sitter-") and . != "tree-sitter-cli") | sub("tree-sitter-"; "")] | @json' package.json)
          echo "languages=$languages" >> $GITHUB_OUTPUT

  build:
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        language: ${{ fromJson(needs.setup.outputs.languages) }}
    steps:
      - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0

      - name: Install Node.js
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: 24
          cache: "npm"

      - run: npm ci

      - name: Rebuild tree-sitter-cli to install binary
        run: npm rebuild tree-sitter-cli --ignore-scripts=false

      - uses: mymindstorm/setup-emsdk@29ba4851d6da084ffdc1e0fc390efadbd75df9d1 # v11
        with:
          version: 2.0.24

      - name: Build ${{ matrix.language }}
        run: npm run build ${{ matrix.language }}

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: wasm-${{ matrix.language }}
          path: out/*.wasm
          retention-days: 7

  verify:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0

      - name: Download all WASM artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          pattern: wasm-*
          path: out
          merge-multiple: true

      - name: List built WASM files
        run: ls -lh out/

      - name: Verify all WASM files exist
        run: |
          # Generate expected files list from package.json
          languages=$(jq -r '.devDependencies | keys[] | select(startswith("tree-sitter-") and . != "tree-sitter-cli") | sub("tree-sitter-"; "")' package.json)
          expected_files=()

          for lang in $languages; do
            # Handle special cases
            if [ "$lang" = "typescript" ]; then
              expected_files+=("tree-sitter-typescript.wasm")
              expected_files+=("tree-sitter-tsx.wasm")
            elif [ "$lang" = "c-sharp" ]; then
              expected_files+=("tree-sitter-c_sharp.wasm")
            else
              expected_files+=("tree-sitter-${lang}.wasm")
            fi
          done

          missing_files=()
          for file in "${expected_files[@]}"; do
            if [ ! -f "out/$file" ]; then
              missing_files+=("$file")
            fi
          done

          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "❌ Missing WASM files:"
            printf '  - %s\n' "${missing_files[@]}"
            exit 1
          fi

          echo "✅ All expected WASM files are present (${#expected_files[@]} files)"

  lint-action:
    name: Lint GitHub Actions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - uses: rhysd/actionlint@e7d448ef7507c20fc4c88a95d0c448b848cd6127 # v1.7.8
        with:
          args: "-color"
