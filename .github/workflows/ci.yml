name: CI
on:
  pull_request:
  push:
    branches:
      - main

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      languages: ${{ steps.set-matrix.outputs.languages }}
    steps:
      - uses: actions/checkout@v3
      - id: set-matrix
        run: |
          languages=$(jq -r '[.devDependencies | keys[] | select(startswith("tree-sitter-") and . != "tree-sitter-cli") | sub("tree-sitter-"; "")] | @json' package.json)
          echo "languages=$languages" >> $GITHUB_OUTPUT

  build:
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        language: ${{ fromJson(needs.setup.outputs.languages) }}
    steps:
      - uses: actions/checkout@v3

      - name: Install Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 24
          cache: "npm"

      - run: npm ci

      - name: Rebuild tree-sitter-cli to install binary
        run: npm rebuild tree-sitter-cli

      - uses: mymindstorm/setup-emsdk@v11
        with:
          version: 2.0.24

      - name: Build ${{ matrix.language }}
        run: npm run build ${{ matrix.language }}

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-${{ matrix.language }}
          path: out/*.wasm
          retention-days: 7

  verify:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v3

      - name: Download all WASM artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wasm-*
          path: out
          merge-multiple: true

      - name: List built WASM files
        run: ls -lh out/

      - name: Verify all WASM files exist
        run: |
          # Generate expected files list from package.json
          languages=$(jq -r '.devDependencies | keys[] | select(startswith("tree-sitter-") and . != "tree-sitter-cli") | sub("tree-sitter-"; "")' package.json)
          expected_files=()

          for lang in $languages; do
            # Handle special cases
            if [ "$lang" = "typescript" ]; then
              expected_files+=("tree-sitter-typescript.wasm")
              expected_files+=("tree-sitter-tsx.wasm")
            elif [ "$lang" = "c-sharp" ]; then
              expected_files+=("tree-sitter-c_sharp.wasm")
            else
              expected_files+=("tree-sitter-${lang}.wasm")
            fi
          done

          missing_files=()
          for file in "${expected_files[@]}"; do
            if [ ! -f "out/$file" ]; then
              missing_files+=("$file")
            fi
          done

          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "❌ Missing WASM files:"
            printf '  - %s\n' "${missing_files[@]}"
            exit 1
          fi

          echo "✅ All expected WASM files are present (${#expected_files[@]} files)"
