name: build-and-publish
on: workflow_dispatch
jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      languages: ${{ steps.set-matrix.outputs.languages }}
    steps:
      - uses: actions/checkout@v3
      - id: set-matrix
        run: |
          languages=$(jq -r '[.devDependencies | keys[] | select(startswith("tree-sitter-") and . != "tree-sitter-cli") | sub("tree-sitter-"; "")] | @json' package.json)
          echo "languages=$languages" >> $GITHUB_OUTPUT

  build:
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        language: ${{ fromJson(needs.setup.outputs.languages) }}
    steps:
      - uses: actions/checkout@v3

      - name: Install Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 24
          cache: "npm"

      - run: npm ci

      - name: Rebuild tree-sitter-cli to install binary
        run: npm rebuild tree-sitter-cli

      - uses: mymindstorm/setup-emsdk@v11
        with:
          version: 2.0.24

      - name: Build ${{ matrix.language }}
        run: npm run build ${{ matrix.language }}

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-${{ matrix.language }}
          path: out/*.wasm
          retention-days: 1

  publish:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v3

      - name: Install Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 24
          cache: "npm"
          registry-url: "https://registry.npmjs.org"

      - name: Update npm to latest version
        run: npm install -g npm@latest

      - run: npm ci

      - name: Download all WASM artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wasm-*
          path: out
          merge-multiple: true

      - name: List built WASM files
        run: ls -lh out/

      - name: Publish to npm with OIDC and provenance
        run: npm publish --provenance --access public
